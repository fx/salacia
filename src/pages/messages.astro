---
/**
 * Messages page displaying AI interaction messages with filtering and pagination.
 *
 * This page provides a comprehensive interface for viewing and managing AI
 * interaction messages stored in the database. It uses server-side rendering
 * for initial data loading and React components for client-side interactivity.
 *
 * Features:
 * - Server-side rendered table with pagination
 * - Client-side filtering and sorting
 * - Responsive design with WebTUI styling
 * - Error handling and loading states
 * - Accessibility support
 */

import { Layout } from '../components/Layout';
import { MessagesApp } from '../components/MessagesApp';
import '../styles/global.css';

// Import the messages service for server-side data fetching
import { MessagesService } from '../lib/services/messages.js';
import type {
  MessagesPaginationParams,
  MessagesFilterParams,
  MessageSort,
} from '../lib/types/messages.js';

// Default pagination parameters for initial page load
const defaultPagination: MessagesPaginationParams = {
  page: 1,
  pageSize: 20,
  sort: {
    field: 'createdAt',
    direction: 'desc',
  } as MessageSort,
};

const defaultFilters: MessagesFilterParams = {};

// Fetch initial data server-side for faster page load
let initialMessages;
let initialError = null;

try {
  initialMessages = await MessagesService.getMessages(defaultPagination, defaultFilters);
} catch (error) {
  console.error('Failed to load initial messages:', error);
  initialError = error instanceof Error ? error.message : 'Failed to load messages';
  // Provide empty data structure for fallback
  initialMessages = {
    messages: [],
    currentPage: 1,
    pageSize: 20,
    totalItems: 0,
    totalPages: 0,
    hasNextPage: false,
    hasPreviousPage: false,
    sort: defaultPagination.sort,
    filters: defaultFilters,
    stats: {
      totalMessages: 0,
      successfulMessages: 0,
      failedMessages: 0,
      successRate: 0,
      totalTokens: 0,
      averageResponseTime: 0,
      uniqueModels: 0,
    },
  };
}
---

<html lang="en" data-webtui-theme="catppuccin-mocha">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Salacia - Messages</title>
    <meta
      name="description"
      content="View and manage AI interaction messages with advanced filtering and search capabilities"
    />
  </head>
  <body data-body="terminal">
    <Layout client:idle>
      <div data-page="messages">
        <!-- Terminal-style page header -->
        <div box-="square" data-panel="header">
          <div data-panel-header>
            <span data-panel-title>MESSAGES MODULE</span>
          </div>
          <div data-panel-content>
            <span>
              AI interaction messages with filtering and search capabilities
            </span>
          </div>
        </div>

        <!-- Messages interface component with server-side data -->
        <div data-messages-container>
          <MessagesApp
            client:load
            initialMessages={initialMessages}
            initialError={initialError}
            defaultPagination={defaultPagination}
            defaultFilters={defaultFilters}
          />
        </div>
      </div>
    </Layout>
  </body>
</html>
