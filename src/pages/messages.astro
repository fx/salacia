---
/**
 * Messages page displaying AI interaction messages with filtering and pagination.
 *
 * This page provides a comprehensive interface for viewing and managing AI
 * interaction messages stored in the database. It uses server-side rendering
 * for initial data loading and React components for client-side interactivity.
 *
 * Features:
 * - Server-side rendered table with pagination
 * - Client-side filtering and sorting
 * - Responsive design with WebTUI styling
 * - Error handling and loading states
 * - Accessibility support
 */

import { Layout } from '../components/Layout';
import { MessagesCursorApp } from '../components/MessagesCursorApp';
import '../styles/global.css';

// Import the messages service for server-side data fetching
import { MessagesService } from '../lib/services/messages.js';
import type { MessagesFilterParams } from '../lib/types/messages.js';
import type {
  MessagesCursorPaginationParams,
  MessagesCursorPaginationResponse,
} from '../lib/types/cursor.js';
import type { MessageDisplay } from '../lib/types/messages.js';

// Default pagination parameters for initial page load
const defaultPagination: MessagesCursorPaginationParams = {
  limit: 20,
  sortBy: 'createdAt',
  sortDirection: 'desc',
};

const defaultFilters: MessagesFilterParams = {};

// Fetch initial data server-side for faster page load
let initialMessages: MessagesCursorPaginationResponse<MessageDisplay>;
let initialError = null;

try {
  initialMessages = await MessagesService.getMessagesWithCursor(defaultPagination, defaultFilters);
} catch (error) {
  console.error('Failed to load initial messages:', error);
  initialError = error instanceof Error ? error.message : 'Failed to load messages';
  // Provide empty data structure for fallback
  initialMessages = {
    data: [],
    meta: {
      count: 0,
      limit: 20,
      hasMore: false,
      sortBy: 'createdAt',
      sortDirection: 'desc',
    },
    cursors: {},
  };
}
---

<html lang="en" data-webtui-theme="catppuccin">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Salacia - Messages</title>
    <meta
      name="description"
      content="View and manage AI interaction messages with advanced filtering and search capabilities"
    />
  </head>
  <body>
    <Layout client:idle>
      <div>
        <!-- Messages interface component with cursor-based pagination -->
        <div>
          <MessagesCursorApp
            client:load
            initialMessages={initialMessages}
            initialError={initialError}
            defaultPagination={defaultPagination}
            defaultFilters={defaultFilters}
          />
        </div>
      </div>
    </Layout>
  </body>
</html>
